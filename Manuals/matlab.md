# MATLAB

- [MATLAB](#matlab)
  - [座標系](#座標系)
  - [データのツリー構造](#データのツリー構造)
  - [プログラム構造](#プログラム構造)
    - [最上位インスタンス／変数](#最上位インスタンス変数)
    - [エンティティ／モデルクラス](#エンティティモデルクラス)
      - [`Condition`: 解析条件の情報を管理するクラス](#condition-解析条件の情報を管理するクラス)
      - [`Constant`: 物理定数や解析固有の定数を管理するクラス](#constant-物理定数や解析固有の定数を管理するクラス)
      - [`Quantity`: 物理量の情報を管理するクラス](#quantity-物理量の情報を管理するクラス)
      - [`Frame`: 時空間座標系の情報を管理するクラス](#frame-時空間座標系の情報を管理するクラス)
      - [`Pattern`: 時空間パターンの情報を管理するクラス](#pattern-時空間パターンの情報を管理するクラス)
      - [`Opereator`: 作用素](#opereator-作用素)
      - [`Transform`: 座標変換](#transform-座標変換)
      - [`Logger`: ログ用クラス](#logger-ログ用クラス)
      - [`Reporter`: レポート用クラス](#reporter-レポート用クラス)
    - [ユーティリティ／ヘルパークラス](#ユーティリティヘルパークラス)
      - [`Utility`: 配列操作など基本的なプログラミング操作のための関数を集めたクラス](#utility-配列操作など基本的なプログラミング操作のための関数を集めたクラス)
      - [`Math`: 数学関数を集めたクラス](#math-数学関数を集めたクラス)
      - [`Predictor`: 順問題計算に関わる関数を集めたクラス](#predictor-順問題計算に関わる関数を集めたクラス)
      - [`Estimator`: 逆問題計算に関わる関数を集めたクラス](#estimator-逆問題計算に関わる関数を集めたクラス)
      - [`Optimizer`: フィッティングや最適化処理のための関数を集めたクラス](#optimizer-フィッティングや最適化処理のための関数を集めたクラス)
      - [`Visualizer`: データの可視化のための関数を集めたクラス](#visualizer-データの可視化のための関数を集めたクラス)
  - [ベストプラクティス](#ベストプラクティス)
    - [ディレクトリ構成](#ディレクトリ構成)
    - [ファイル構成](#ファイル構成)
    - [スクリプト・関数](#スクリプト関数)
      - [入出力](#入出力)
      - [ローカル関数](#ローカル関数)
      - [その他](#その他)
    - [ステートメント](#ステートメント)
      - [反復](#反復)
      - [条件分岐](#条件分岐)
    - [オブジェクト](#オブジェクト)
      - [定数](#定数)
      - [変数](#変数)
    - [命名規則](#命名規則)
      - [共通事項](#共通事項)
      - [定数](#定数-1)
      - [変数](#変数-1)
      - [構造体](#構造体)
      - [スクリプト・関数](#スクリプト関数-1)
    - [フォーマット](#フォーマット)
      - [演算子の優先順位](#演算子の優先順位)
      - [空白](#空白)
      - [その他](#その他-1)
    - [コメント・ドキュメンテーション](#コメントドキュメンテーション)
  - [Git関連](#git関連)
  - [参考ページ](#参考ページ)
    - [プロット](#プロット)
    - [スタイル](#スタイル)

## 座標系

RAS右手系

## データのツリー構造

- exam: その日の実験．subjectに近いが同じ被験者を複数日測定する場合もあるので異なる．
- series: 個別の撮像シーケンスや刺激条件．
- instance: 単一データの中の区分．

## プログラム構造

MRI, MPI, NMIに共通

これらはCoreリポジトリ内に作る．
MRI/NMI/MPIの各親リポジトリからサブモジュールとして参照する．
lib/labに配置する。

クラス名はPascalCase．
これから作られたインスタンスはcamelCase．

- `conditions = Condition(); % エンティティクラスに対するインスタンス化`
- `util = Utility(); % ユーティリティクラスもインスタンス化可能にしている`

### 最上位インスタンス／変数

- `conditions`: 解析に関する情報．`Condition`クラス．
- `constants`: 物理定数やその他の定数．`Constant`クラス．
- `sources`/`properties`: 推定対象の量．`Quantity`クラス．
- `fields`: 観測対象の量．`Quantity`クラス．
- `operators`: 作用素情報．`Operator`クラス．とりあえず普通の構造体．
- `transforms`: 座標変換情報．`Transform`クラス．とりあえず普通の構造体．
- `annotations`: イベント情報など？`Annotation`クラス．とりあえず普通の構造体．
- `covariances`: 分散情報など？`Covariance`クラス．とりあえず普通の構造体．

### エンティティ／モデルクラス

設計図．
プロパティを持ちインスタンス化される．

#### `Condition`: 解析条件の情報を管理するクラス

プロパティ

- `exam`: 実験ID
- `series`: プロトコルID
- `source`
  - `type`: `"discrete"`, `"distributed"`, `"patch"`など．
  - `position`
  - `orientation`
- `method`
- `filter`
- `regularization`
- `comment`

> これ以外にも動的に追加できるようにする

メソッド

#### `Constant`: 物理定数や解析固有の定数を管理するクラス

プロパティは動的に変更できるようにする

#### `Quantity`: 物理量の情報を管理するクラス

プロパティ

- `frames`: 時空間座標系．`Frame`クラスからなる辞書．キーは`"space"`, `"time"`, `"spatial frequency"`, `"temporal frequency"`など．
- `patterns`: 時空間パターン．`Pattern`クラスからなる辞書．キーは`"magnetic field"`など各種物理量．
- `metrics`: 上記パターンから計算されるエネルギーや誤差率などの集約値．構造体からなる辞書．キーは`"magnetic field"`など各種物理量．
- `histories`: 処理の履歴．構造体からなる辞書．キーは`"magnetic field"`など各種物理量．

メソッド

#### `Frame`: 時空間座標系の情報を管理するクラス

プロパティ

- `instant`: 時間点
- `position`: 位置座標
- `orientation`: 方向．ない場合も．
- `triangulation`: 三角分割のときに存在．
- `type`: 点群の種別．`"scatter"`, `"grid"`, `"mesh"`のどれか．
- `coordinate`: 値の座標系．

メソッド

- frequency: instantからfrequencyのリストをつくる．片側両側を引数で指定できるようにする．
- transformCoordinate: 座標系を変換する

#### `Pattern`: 時空間パターンの情報を管理するクラス

プロパティ

- `true`
- `measured`
- `filtered`
- `estimated`
- `predicted`
- `type`: 場の種別．`"scalar"`, `"vector"`, `"tensor"`のどれか．

メソッド

フィルタリングなどの各種信号／画像処理関数

#### `Opereator`: 作用素

プロパティは動的に変更できるようにする

- `leadfield`
- `leadmoment`
- `ssp`
- `sss`
- `ica`
- `assembler`: コイル型センサの重み
- `whitener`: もしくはwhitener

メソッド

- w = whitener(v, method): 分散行列から白色化（球状化）行列を計算する
- v = variance(w): 白色化行列から分散行列を計算する

#### `Transform`: 座標変換

ある基準座標からの変換行列．

プロパティは動的に追加可能．

- `head`
- `meg`
- `mri`

#### `Logger`: ログ用クラス

処理経過のコマンドウィンドウへの表示など

#### `Reporter`: レポート用クラス

図のエクスポートなど

### ユーティリティ／ヘルパークラス

道具箱．
プロパティを持たずインスタンス化されない．

#### `Utility`: 配列操作など基本的なプログラミング操作のための関数を集めたクラス

略称`util`

#### `Math`: 数学関数を集めたクラス

略称`math`

#### `Predictor`: 順問題計算に関わる関数を集めたクラス

略称`fwd`

#### `Estimator`: 逆問題計算に関わる関数を集めたクラス

略称`inv`

#### `Optimizer`: フィッティングや最適化処理のための関数を集めたクラス

略称`opt`

#### `Visualizer`: データの可視化のための関数を集めたクラス

略称`viz`

## ベストプラクティス

### ディレクトリ構成

`$PROJECT_DIR`以下のディレクトリ構成．

最上位の構成は以下の通り．

- `app`：メインアプリ(`CUI.m`, `GUI.mlapp`)
- `doc`：ドキュメント(`readme.md`, `changelog.md`, `license.md`)
- `data`：データ(`.mat`)
- `lib`：クラス(`.m`)
- `src`：関数(`.m`)
  - `+project1/`: プロジェクトに固有の関数群．特に`Main.m`を含む．
  - `+project2/`
  - `+project3/`
- `test`：テスト用の関数・スクリプト(`.m`)
- `util`：メインアプリで使用されない関数・スクリプト(`.m`)
- `local`：Git管理から外すファイル

これらの下層の構成は状況に応じて定める．

> dataはMATファイルに変換したもの．生データ(`.dcm`, `.csv`, ...)は別のディレクトリで管理．

### ファイル構成

モジュール化する．

- メインアプリが行う処理をスクリプトに細分する
- 各スクリプトが行う処理を関数に細分する
- 各関数が担うのは限定された単一の処理とする
- ファイル数を増やさないためにはローカル関数を利用する
- 複数のファイルに現れる処理は一つの関数ファイルにパッケージ化する

> 特に，外部とのIO部分を担うスクリプト・関数は独立させておく．IO部分は仕様が変更されやすい．

### スクリプト・関数

#### 入出力

- `inputParser`による構文解析を行い，パース済みの入力(`P.Results`以下)を使ってその後の処理を行う．また，パースの過程で入力の妥当性の検証も行う．チェック用の関数としては以下が考えられる．
  - 既存のMATLAB関数(`isa`)
  - 無名関数
  - 自前のローカル関数
  - `validateattributes()`
  - `ischar(validatestring())`
  > 自分でエラー文を作成するよりは，MATLAB既定の関数やvalidation関数を用いることで，既定の形式かつロケールに合わせた言語でエラー文を表示させられる．
- 関数の入力の型には柔軟性を持たせる
  > 画像を入力とする場合，二値画像，整数値グレー画像，実数値グレー画像を受け付けるようにする
  > カラー画像にも適用できる関数の場合はそれも受け入れるようにする
- 関数の引数が多い場合は，関連する入力のセットを構造体にする
- 構造体とすることで引数を定まった順番で与える負担が減る
  > 反復を行う関数なら`Option`という構造体を用意して`initialValue`, `maximumIteration`, `optimalTorelance`等を格納する．

#### ローカル関数

- 一つのスクリプト・関数ファイル中に任意の個数のローカル関数を含められる
- ローカル関数は他の関数からは呼び出されない（隠蔽される）
- 一つのスクリプト・関数内のみで使用される関数はローカル関数として作成すると，ファイル数の増加が抑えられる
- 複数のファイル内で用いられる場合は別ファイルとして作成するべき

#### その他

- 可能な限り既存の関数を利用する
- 大域変数よりも関数の引数の使用する
- すべての関数に対してテストスクリプトを書くようにする
- `eval`や`assignin`の使用を避ける
- テキスト情報はchar型ではなくstring型を基本とし，操作系関数は新しいものを使う
  > strfind, strcmp, strrep等の代わりにmatches, contains, startsWith, endsWith, replace等を用いる．
  > 詳細は[テキストの検索と置換](https://jp.mathworks.com/help/matlab/matlab_prog/searching-and-replacing.html)および[テキストの比較](https://jp.mathworks.com/help/matlab/matlab_prog/string-comparisons.html)を参照

### ステートメント

#### 反復

- ループ内で使用する変数はその直前で初期化（アロケート）しておく
- ループでの`break`と`continue`の使用は最小限に抑え，可読性が大きく向上する場合に限る
- 多重の入れ子ループの場合各end行にコメントを入れ，その入れ子内で何が行われたか分かるようにする

#### 条件分岐

- 条件ステートメントは明瞭に
- 複雑な場合は一時的な変数を使用して分割する

```matlab
isValid = (value >= lowerLimit) & (value <= upperLimit);
isNew = ~ismember(value, valueArray);
if (isValid & isNew)
  ...
end
```

- 否定の条件変数は使用しない
  > `isNotValid`ではなく`~isValid`とする
- if-elseはよく起こる場合を先に書く
- switch文には必ずotherwiseを付ける
- switchの各条件は文字列だとわかりやすい

### オブジェクト

#### 定数

- マジックナンバーを避ける
- 定数用の変数を用意しておく
  > Javaでは定数をまとめるのに定数クラスを作成する．
  > これに倣って定数をまとめた構造体を用意する．

#### 変数

- グローバル変数の使用は変数のスコープや依存関係を分かりにくくするため避ける
  > 関数の引数に加えてしまうのが良い
- メモリ要件が厳しい場合を除いて，同じ変数名を使いまわさない
  > 変数名と内容が一意に対応するようにする
- 配列の次元に関する規則を定める
  - 時間データ：(1, t)
  - 空間データ：(x, y, z)
  - 時空間データ：(x, y, z, t)
  - 多点時間データ：(t, c)：FieldTripの規則(c, t)との違いに注意
  - 多点空間データ：(x, y, z, c)
  - 多点時空間データ：(x, y, z, t, c)：MRI(freqEnc, phaseEnc, slice, echo, channel)に相当

### 命名規則

#### 共通事項

- すべてパスカルケースかキャメルケースで記述する
  > スネークケースはTeXインタプリタが下付き添字と解釈するので避ける．
  > ケバブケースはMATLABがminusと解釈されるので使用不可．
- 単語を省略しない
  > `compTotWid`ではなく`computeTotalWidth`とする
- 数学関数として定着しているものは省略する
  > `max`, `gcd`

#### 定数

- パスカルケース
- 同種の定数は接頭辞で区別してもよい
  > `ColorRed`, `ColorBlue`, `ColorGreen`

#### 変数

- キャメルケース
- スコープの長い変数ほど正確な名前に，短い変数ほど簡単な名前にする
- 原則的に言葉を変数名にする
- 物理学で標準的な表記として予約されている記号を用いる場合は数式記号を変数名にする

```matlab
volume = width * height * depth; % avoid V = w * h * d;
Jx = sigma * Ex; % 物理的に通じる
dx; dt; % スコープが短いならあり
```

- 単数形変数があるなら複数形変数は作成しない．代わりに`Array`や`List`等の接尾辞をつける．

```matlab
point = 0;
pointArray = zeros(3, 3); % Do not use `points`
```

変数の接頭辞として以下を予約する．

- `s`：配列の各次元の要素数が作る行ベクトル（`sArray = size(Array)`ということ）
- `n`：総数
- `i`：反復子

```matlab
for iFile = 1 : nFiles
    for iSubject = 1 : nSubjects
        ...
    end
end
```

- `ind`：任意の次元の配列の線形インデックス
- `row`：二次元配列の行のインデックス
- `col`：二次元配列の列のインデックス
- `dim1`, `dim2`, `dim3`, ...：多次元配列の各次元のインデックス
- `sub`：二次元以上の配列の各次元のインデックスを並べた一次元配列
- `is`：論理型変数

#### 構造体

- パスカルケース
- フィールド名に構造体名を加えない
  > `Segment.segmentLength`ではなく`Segment.length`とする

#### スクリプト・関数

- スクリプトはパスカルケース，関数はキャメルケース
- 単一出力の関数はその名前を関数名にする：`mean`
- 出力のない（ハンドルのみ出力する）関数は何をするかを名前にする：`plot`
- findをインデックスを返す関数の接頭辞にする
- isを論理値を返す関数の接頭辞にする
- 関数の接頭辞として以下はセッタ・ゲッタに予約し，それ以外の文脈で使わない．
  - `set`
  - `get`

### フォーマット

方針として，MATLABデスクトップ（MATLABの公式IDE）の既定に従うのが良い．

#### 演算子の優先順位

以下のように定められている．

1. 小かっこ(`()`)
2. 転置(`.'`)，べき乗(`.^`)，複素共役転置(`'`)，行列のべき乗(`^`)
3. 単項マイナス(`.^-`)，単項プラス(`.^+`)，論理否定(`.^~`) を伴うべき乗，および単項マイナス(`^-`)，単項プラス(`^+`)，論理否定(`^~`)を伴う行列のべき乗
4. 単項プラス(`+`)，単項マイナス(`-`)，論理否定(`~`)
5. 乗算(`.*`)，右除算(`./`)，左除算(`.\`)，行列乗算(`*`)，行列右除算(`/`)，行列左除算(`\`)
6. 加算(`+`)，減算 (`-`)
7. コロン演算子(`:`)
8. より小(`<`)，以下(`<=`)，より大(`>`)，以上(`>=`)，等価(`==`)，等価でない(`~=`)
9. 要素単位のAND(`&`)
10. 要素単位のOR(`|`)
11. ショートサーキットのAND(`&&`)
12. ショートサーキットのOR(`||`)

これを厳密に記憶して実践するのは困難であるから，丸括弧を冗長に使用するべきである．
また，論理演算と数値演算を混合（暗黙の変換）しないように決めておけば，これらを別々に記憶しておけばよい．
より大まかな以下の関係だけ記憶する．

数値演算

1. 丸括弧(`()`)
1. 配列転置(`.'`)，配列冪乗(`.^`)，複素共役転置(`'`)，行列冪乗(`^`)
1. 単項プラス(`+`)，単項マイナス(`-`)
1. 配列乗算(`.*`)，配列右除算(`./`)，配列左除算(`.\`)，行列乗算(`*`)，行列右除算(`/`)，行列左除算(`\`)
1. 加算(`+`)，減算 (`-`)
1. コロン演算子(`:`)

論理演算

1. 論理否定(`~`)
1. より小(`<`)，以下(`<=`)，より大(`>`)，以上(`>=`)，等価(`==`)，等価でない(`~=`)
1. 要素単位のAND(`&`)，要素単位のOR(`|`)
1. ショートサーキットのAND(`&&`)，ショートサーキットのOR(`||`)

#### 空白

以下の部分は必ず空白で囲む．

- 等号：`=`
- 加算と減算：`+`, `-`
- 論理演算子：`&&`, `||`, `==`, `~=`, `<`, `>`, `<=`, `>=`

以下の部分には空白を置かない．

- コンマ演算子：`:`

以下の部分は状況に応じて決める．

- 乗算と除算：`*`, `/`

#### その他

- 4インデント
- 80カラム
- コード上の改行は自然な区切り位置で行う
- 一行につき一動作
- 演算子の優先順位規定に頼りすぎずに，括弧を積極的に用いる
- 小数点の前の0は省略しない
- 短いif, while, for文は一行にした方が見やすい場合がある
- switch分の各caseも一行にした方が可読性が上がる場合がある

```matlab
if condition, statement; end
while condition, statement; end
for iVar = 1 : nVars, statement; end
switch var
    case pattern1, statement;
    case pattern2, statement;
    case pattern3, statement;
end
```

- 適当な区切りで空行を設ける
- MATLABエディタのセクション機能(`%%`)で区切る

### コメント・ドキュメンテーション

- MATLABでは変数の宣言が不要な場合があるから注釈を忘れないように注意する
- 複数行コメントを積極的に利用する
- 関数の`function`宣言の直後にコメントを書く（ヘッダコメント）ことでhelp参照できるようにする
- ヘッダコメントでは関数の全体説明と構文，入出力の説明を行う
- 著作権と変更履歴はhelpに表示されないようにヘッダコメントから一行空ける

## Git関連

CLIソフトであるGitを扱いやすくするためのGUIソフトは色々とあるが，MATLABプログラムの場合MATLABデスクトップにGit関連の操作を行うGUIツールが組み込まれている．
MATLABデスクトップアプリから出ることなく一通りのGit関連操作が可能．

## 参考ページ

### プロット

1. [MATLABの公式プロット関連資料](https://jp.mathworks.com/help/matlab/2-and-3d-plots.html)
1. [MATLAB Plot Gallery](https://jp.mathworks.com/products/matlab/plot-gallery.html)

### スタイル

1. [The Elements of MATLAB Style (Amazon.co.jp)](https://www.amazon.co.jp/exec/obidos/ASIN/0521732581/asakai-22/ref=nosim/)
1. [MATLAB Style Guidelines 2.0 (MATLAB File Exchange)](https://jp.mathworks.com/matlabcentral/fileexchange/46056-matlab-style-guidelines-2-0)
1. [MATLAB Style Guidelines 2.0の和訳（東北大学川又研究室）](http://www.mk.ecei.tohoku.ac.jp/home_page_j.html)
